<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=EUC-KR">
<title>Insert title here</title>
</head>
<body>
<div class="content">이유를 간단히 설명드리면,<br /><br />SpringMVC를 이용한 개발에서 Controller류는 xxx-servlet.xml에 그 외의 Service, Dao류는 applicationContext*.xml에 등록해야 합니다. 직접 등록이 아닌 Scanner을 사용할 경우 중복하지 않도록 해야 합니다. 따라서 처음 만드신 것처럼 xxx-servlet.xml에서 모든 Stereotype 빈을 모두 다 검색하는 component-scan 설정은 잘못됐습니다. <br /><br />이 원칙만 잘 준수하시면 아무 문제없을 것입니다.<br /><br />이번엔 좀 복잡하게 설명해보죠.<br /><br />세가지  사용하신 stereotype이 있습니다. @Repository, @Service, @Controller죠.<br /><br />제가 이전에 작성한 <!-- l --><a class="postlink-local" href="http://forum.ksug.org/viewtopic.php?f=5&amp;t=20#p33">viewtopic.php?f=5&amp;t=20#p33</a><!-- l --> 을 읽어보시면 잘 설명이 되어있는 내용이 있습니다. 일반 applicationContext*.xml에 설정한 내용과 xxx-servlet.xml에 설정한 내용은 두개의 다른 ApplicationContext(이하 AC)로 만들어지고 xxx-servlet.xml의 AC는 applicationContext*.xml에 의해서 만들어진 AC의 child context로 등록이 됩니다. <br /><br />상위 AC를 ac, 웹에서 정의된 AC를 web-ac라고 불러보죠.<br /><br />원래 하신 설정에 따르면 ac에서는 controller,form류(@Controller)를 제외한 나머지만 scan하도록 되어있습니다. 따라서 @Repostiory, @Service가 붙은 bean들이 등록이 되겠죠.<br /><br />web-ac는 exclude조건없이 full-scan을 했습니다. 따라서 @Repository, @Service, @Controller가 붙은 빈들이 다 등록이 됐죠.<br /><br />그리고 ac와 web-ac가 상-하위 ac관계를 가집니다. 이때 같은 bean이 두번 등록되도 문제는 없습니다. 하위 context에서는 상위 context에 등록된 bean을 override합니다. 하위 context에서 먼저 bean을 찾고, 없으면 그때 상위를 찾기 때문에 override한 것과 마찬가지입니다.<br /><br />따라서<br />ac - @Service, @Repository<br />web-ac - @Service, @Repository, @Controller<br />이렇게 각각 빈들을 가지고 있는 상태입니다.<br /><br />스프링이 transaction을 적용하는 방법은 AOP를 이용해서 해당 빈의 proxy를 만들어서 tx가 적용되는 bean을 바꿔치기 하는 방법을 이용합니다. 그러면 원래 @Service(@Transactional)이 붙은 빈은 뒤로 숨고 tx가 적용된 proxy bean이 @Service가 붙은 bean으로 대치됩니다. tx설정은 ac에만 되어있기 때문에 이 것이 적용되면 <br /><br />ac - tx적용(@Service), @Repository<br />web-ac - @Service, @Repository, @Controller<br /><br />이런 형태가 됩니다.<br /><br />web-ac쪽은 tx가 적용되지 않은 @Service가 그대로 남아있습니다.<br /><br />그리고 @Controller가 동작하고 여기에 @Autowired를 걸면, 우선 같은 context에서 검색을 합니다. 여기서도 @Service가 지정된 같은 bean이 등록되어있기 때문에 web-ac에 등록된 @Service bean을 사용합니다. 하지만 이 bean은 tx를 위한 proxy bean이 아니기 때문에 tx가 동작하지 않습니다. 따라서 처음과 같은 문제가 발생합니다.<br /><br />다음은 @Service를 떼고 &lt;bean&gt;으로 등록하니 tx가 적용된 상황을 살펴보죠.<br />이때는 @Service에 의해서 scan되지는 않고 bean에 의해서 명시적으로 service bean이 등록됩니다. 물론 &lt;bean&gt;을 등록한 ac에서만 되겠죠. web-ac에서는 full-scan을 하지만, @Service가 없기 때문에 등록되지 않습니다.<br /><br />ac - Service, @Repository<br />web-ac - @Repository, @Controller<br /><br />이런 상황이 되는거죠.<br /><br />여기에 tx설정이 적용되면 @Transactional이 붙은 것을 ac 내에서 찾아서 적용하므로<br /><br />ac - tx적용(Service), @Repository<br />web-ac - @Repository, @Controller<br /><br />이런 구조가 됩니다.<br /><br />이제 Controller가 @Autowired에 의해서 service를 찾으면 이때는 ac에 등록된 tx적용(Service) 빈이 호출됩니다. 그러니 당연히 tx가 먹겠죠.<br /><br />따라서 앞에서 하신 모든 가정들(@Service, @Transactional은 같이 쓰면 안된다, 인터페이스에 적용을 안해서 그렇다거나.. 기타등등)은 다 틀렸습니다.<br /><br />마지막으로 제가 알려드린대로 하시면 <br /><br />ac - tx적용(@Service), @Repository<br />web-ac -@Controller<br /><br />이렇게 깔끔하게 설정되겠죠.<br /><br />Web을 사용하는 스프링 애플리케이션의 설정의 기본원칙만 지키시면 아무 문제가 없는 것입니다. 보통 component-scan을 사용하면 exclude, include등을 잘 적용하지 못해서 이런 문제가 발생할 수 있습니다. 편리한만큼 신경쓸 것도 있는거죠.<br /><br />그리고 exclude 하실때 이름을 가지고 regex를 적용하셨는데 그보다는 annotation filter을 이용하시는 것이 더 깔끔할 것 같습니다. 아예 web쪽과 나머지를 root경로부터 분리하면 간단하긴 하지만, 보통 모듈별로 몰아두기 때문에 annotation 방식이 편합니다.<br /><br />제가 사용하는 방법은<br /><br />ac쪽은<br /><br /><dl class="codebox"><dt>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code>&nbsp; &nbsp;&lt;context:component-scan base-package=&quot;base.package...&quot;&gt;<br />&nbsp; &nbsp;&nbsp; &nbsp;&lt;context:exclude-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Controller&quot; /&gt;<br />&nbsp; &nbsp;&lt;/context:component-scan&gt;</code></dd></dl><br /><br />web-ac쪽은<br /><br /><dl class="codebox"><dt>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></dt><dd><code>&nbsp; &nbsp;&lt;context:component-scan base-package=&quot;base.package...&quot; use-default-filters=&quot;false&quot;&gt;<br />&nbsp; &nbsp;&nbsp; &nbsp;&lt;context:include-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Controller&quot; /&gt;<br />&nbsp; &nbsp;&lt;/context:component-scan&gt;</code></dd></dl><br /><br />입니다.</div>
</body>
</html>